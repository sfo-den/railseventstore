#!/usr/bin/env ruby

# frozen_string_literal: true

require "bundler/inline"
require "erb"
require "psych"

gemfile do
  source "https://rubygems.org"
  gem "szczupac", ">= 0.4.0"
end

RUBY_VERSIONS = [
  RUBY_3_2 = "ruby-3.2",
  RUBY_3_1 = "ruby-3.1",
  RUBY_3_0 = "ruby-3.0",
  RUBY_2_7 = "ruby-2.7",
  TRUFFLE_RUBY = "truffleruby",
]

DATA_TYPES = [
  DATA_BINARY = "binary",
  DATA_JSON = "json",
  DATA_JSONB = "jsonb"
]

DATABASE_URLS = [
  SQLITE = "sqlite3:db.sqlite3",
  POSTGGRES_12 = "postgres://postgres:secret@localhost:10012/rails_event_store?pool=5",
  POSTGRES_11 = "postgres://postgres:secret@localhost:10011/rails_event_store?pool=5",
  MYSQL_8 = "mysql2://root:secret@127.0.0.1:10008/rails_event_store?pool=5",
  MYSQL_5 = "mysql2://root:secret@127.0.0.1:10005/rails_event_store?pool=5"
]

[
  {
    name: "aggregate_root",
    matrix:
      Szczupac.generate(
        Szczupac.axis("ruby", RUBY_VERSIONS),
        Szczupac.axis("gemfile", %w[Gemfile])
      ),
    template: "ruby.yaml.erb"
  },
  {
    name: "ruby_event_store",
    matrix:
      Szczupac.generate(
        Szczupac.axis("ruby", RUBY_VERSIONS),
        Szczupac.axis("gemfile", %w[Gemfile])
      ),
    template: "ruby.yaml.erb"
  },
  {
    name: "ruby_event_store-rspec",
    matrix:
      Szczupac.generate(
        Szczupac.axis("ruby", RUBY_VERSIONS),
        Szczupac.axis("gemfile", %w[Gemfile])
      ),
    template: "ruby.yaml.erb"
  },
  {
    name: "ruby_event_store-browser",
    matrix:
      Szczupac.generate(
        Szczupac.axis("ruby", RUBY_VERSIONS),
        Szczupac.axis("gemfile", %w[Gemfile Gemfile.rack_2_0])
      ),
    template: "elm.yaml.erb"
  },
  {
    name: "rails_event_store",
    matrix:
      Szczupac.generate(
        Szczupac.axis("ruby", RUBY_VERSIONS),
        Szczupac.axis("gemfile", %w[Gemfile Gemfile.rails_6_1 Gemfile.rails_6_0])
      ),
    template: "ruby.yaml.erb"
  },
  {
    name: "ruby_event_store-active_record",
    matrix:
      Szczupac.generate(
        Szczupac.axis("ruby", RUBY_VERSIONS),
        Szczupac.axis("gemfile", %w[Gemfile]),
        [
          *Szczupac.generate(
            Szczupac.axis("database", [SQLITE]),
            Szczupac.axis("datatype", [DATA_BINARY])
          ),
          *Szczupac.generate(
            Szczupac.axis("database", [POSTGGRES_12, POSTGRES_11]),
            Szczupac.axis("datatype", [DATA_JSONB, DATA_JSON, DATA_BINARY])
          ),
          *Szczupac.generate(
            Szczupac.axis("database", [MYSQL_8, MYSQL_5]),
            Szczupac.axis("datatype", [DATA_BINARY, DATA_JSON])
          )
        ]
      ),
    template: "db.yaml.erb"
  }
].each do |gem|
  name, matrix, template = gem.values_at(:name, :matrix, :template)

  File.write(
    File.join(__dir__, "../../.github/workflows/#{name}.yml"),
    ERB.new(File.read(File.join(__dir__, template))).result_with_hash(
      name: name,
      working_directory: name,
      matrix: Psych.dump(matrix).lines.drop(1).join(" " * 10).strip
    )
  )
  print "."
end

puts
